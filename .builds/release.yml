image: nixos/unstable
oauth: git.sr.ht/REPOSITORIES:RW
sources:
  - https://git.sr.ht/~yuiyukihira/featurize
packages:
  - nixos.hut
environment:
  NIX_CONFIG: "experimental-features = nix-command flakes"
tasks:
  - check-for-git-tag: |
      if [[ $(git tag --points-at HEAD | wc -l) -eq 0 ]]; then \
        echo "not a release, skipping"; \
        complete-build; \
      fi
  - build: |
      cd ~/featurize
      nix build .#auth
  - check: |
      cd ~/featurize
      nix flake check
  - release: |
      hut git artifacts upload result/bin/auth
